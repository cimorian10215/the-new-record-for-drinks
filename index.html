import React, { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'firebase/auth';
import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, deleteDoc } from 'firebase/firestore';

// --- Firebase è¨­å®š ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
// ä½¿ç”¨ç‰¹å®šçš„å„²å­˜ ID ä»¥å…è·Ÿå‡ºå‹¤ç´€éŒ„æ··æ·†
const appId = typeof __app_id !== 'undefined' ? __app_id : 'bubble-tea-tracker-2026';

export default function App() {
  const [user, setUser] = useState(null);
  const [records, setRecords] = useState({});
  const [loading, setLoading] = useState(true);
  const [modalOpen, setModalOpen] = useState(false);
  const [selectedDate, setSelectedDate] = useState('');
  
  // ç·¨è¼¯é è¨­å€¼
  const defaultEditData = { 
    shop: '', 
    item: '', 
    price: '', 
    ice: 'å°‘å†°', 
    sugar: 'å¾®ç³–', 
    note: '' 
  };
  const [editData, setEditData] = useState(defaultEditData);
  const [statusMsg, setStatusMsg] = useState('');

  // é¸é …è¨­å®š
  const iceOptions = ['æ­£å¸¸', 'å°‘å†°', 'å¾®å†°', 'å»å†°', 'å¸¸æº«', 'æº«', 'å›ºå®š'];
  const sugarOptions = ['å…¨ç³–', 'å°‘ç³–', 'åŠç³–', 'å¾®ç³–', 'ä¸€åˆ†', 'ç„¡ç³–', 'å›ºå®š'];

  // 1. èº«ä»½é©—è­‰
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (err) {
        console.error("Auth Error:", err);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, (u) => setUser(u));
    return () => unsubscribe();
  }, []);

  // 2. ç›£è½ Firestore (è®€å– 'bubble_tea_data')
  useEffect(() => {
    if (!user) return;
    // é€™è£¡å°‡æ–‡ä»¶ ID æ”¹ç‚º bubble_tea_data ä»¥å€éš”å…¶ä»–æ‡‰ç”¨
    const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'bubble_tea_data');
    
    const unsubscribe = onSnapshot(docRef, (docSnap) => {
      if (docSnap.exists()) {
        setRecords(docSnap.data().records || {});
      } else {
        setRecords({});
      }
      setLoading(false);
    }, (error) => {
      console.error("Firestore Listen Error:", error);
      setLoading(false);
    });

    return () => unsubscribe();
  }, [user]);

  const showStatus = (msg) => {
    setStatusMsg(msg);
    setTimeout(() => setStatusMsg(''), 2500);
  };

  // å„²å­˜é‚è¼¯
  const saveToCloud = async (newRecords) => {
    if (!user) return;
    try {
      const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'bubble_tea_data');
      await setDoc(docRef, { records: newRecords }, { merge: true });
      showStatus('è¨˜å¸³æˆåŠŸï¼');
    } catch (err) {
      console.error("Save Error:", err);
      showStatus('å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯');
    }
  };

  const openModal = (date) => {
    setSelectedDate(date);
    const existing = records[date] || defaultEditData;
    setEditData(existing);
    setModalOpen(true);
  };

  const handleSave = () => {
    if (!editData.shop || !editData.item) {
      alert("è«‹è‡³å°‘è¼¸å…¥åº—åå’Œå“é …");
      return;
    }
    const newRecords = { ...records, [selectedDate]: editData };
    setRecords(newRecords);
    saveToCloud(newRecords);
    setModalOpen(false);
  };

  const handleDelete = () => {
    const newRecords = { ...records };
    delete newRecords[selectedDate];
    setRecords(newRecords);
    saveToCloud(newRecords);
    setModalOpen(false);
  };

  // çµ±è¨ˆé‚è¼¯
  const stats = Object.values(records).reduce((acc, r) => {
    const p = parseInt(r.price) || 0;
    acc.totalSpent += p;
    acc.totalCups += 1;
    return acc;
  }, { totalSpent: 0, totalCups: 0 });

  const avgPrice = stats.totalCups > 0 ? Math.round(stats.totalSpent / stats.totalCups) : 0;

  // æ¸²æŸ“æ—¥æ›†
  const renderCalendar = () => {
    // ç”¢ç”Ÿ 2026 å…¨å¹´æœˆä»½
    const range = Array.from({ length: 12 }, (_, i) => ({ y: 2026, m: i }));

    return range.map(({y, m}) => {
      const firstDay = new Date(y, m, 1).getDay();
      const totalDays = new Date(y, m+1, 0).getDate();
      const days = [];
      for (let i = 0; i < firstDay; i++) days.push(null);
      for (let i = 1; i <= totalDays; i++) days.push(i);

      return (
        <div key={`${y}-${m}`} className="bg-white p-5 rounded-3xl shadow-sm border border-orange-100">
          <h4 className="font-black text-lg mb-3 text-orange-800">{y} / {m+1}æœˆ</h4>
          <div className="grid grid-cols-7 gap-1 text-center mb-1">
            {['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].map(d => (
              <div key={d} className="text-[10px] font-bold text-orange-300 uppercase">{d}</div>
            ))}
          </div>
          <div className="grid grid-cols-7 gap-1">
            {days.map((d, idx) => {
              if (d === null) return <div key={`empty-${idx}`} />;
              const dStr = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
              const isWk = (new Date(y,m,d).getDay() === 0 || new Date(y,m,d).getDay() === 6);
              const record = records[dStr];

              return (
                <div 
                  key={dStr}
                  onClick={() => openModal(dStr)}
                  className={`aspect-square flex flex-col items-center justify-start pt-1 cursor-pointer rounded-xl relative border transition-all hover:scale-110 active:scale-95
                    ${record ? 'bg-orange-50 border-orange-400' : 'border-transparent hover:bg-slate-50'}
                  `}
                >
                  <span className={`text-xs font-bold leading-none ${isWk && !record ? 'text-rose-400' : 'text-slate-600'}`}>{d}</span>
                  {record && (
                    <>
                      <div className="text-lg mt-0.5">ğŸ§‹</div>
                      <div className="text-[8px] font-black text-orange-600 bg-white/80 px-1 rounded-full mt-auto mb-1 shadow-sm">
                        ${record.price}
                      </div>
                    </>
                  )}
                </div>
              );
            })}
          </div>
        </div>
      );
    });
  };

  if (loading) return (
    <div className="min-h-screen flex items-center justify-center bg-orange-50">
      <div className="animate-spin rounded-full h-12 w-12 border-4 border-orange-200 border-t-orange-500"></div>
    </div>
  );

  return (
    <div className="min-h-screen bg-orange-50 p-4 md:p-8 font-sans pb-24">
      {statusMsg && (
        <div className="fixed top-6 right-6 z-50 bg-slate-800 text-white px-6 py-3 rounded-2xl shadow-2xl animate-bounce font-bold">
          {statusMsg}
        </div>
      )}

      <div className="max-w-6xl mx-auto">
        {/* Header */}
        <header className="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-6 bg-white p-8 rounded-[2.5rem] shadow-xl border border-orange-100">
          <div>
            <div className="flex items-center gap-3 mb-2">
              <span className="text-4xl">ğŸ¥¤</span>
              <h1 className="text-3xl font-black text-slate-800">æ‰‹æ–çµ±è¨ˆ 2026</h1>
            </div>
            <p className="text-slate-400 font-bold text-sm ml-1">é›²ç«¯åŒæ­¥ä¸­ (ID: {user?.uid.slice(0,6)})</p>
          </div>
          <div className="flex gap-3 w-full md:w-auto overflow-x-auto pb-2 md:pb-0">
            <StatCard label="å¹´åº¦ç¸½èŠ±è²»" val={`$${stats.totalSpent.toLocaleString()}`} color="bg-slate-800" />
            <StatCard label="ç´¯ç©æ¯æ•¸" val={`${stats.totalCups} æ¯`} color="bg-orange-500" />
            <StatCard label="å¹³å‡å–®åƒ¹" val={`$${avgPrice}`} color="bg-amber-400" textColor="text-slate-900" />
          </div>
        </header>

        {/* Calendar Grid */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5 mb-12">
          {renderCalendar()}
        </div>

        {/* Recent List */}
        <div className="bg-white rounded-[2.5rem] shadow-xl border border-orange-100 overflow-hidden">
          <div className="p-6 bg-orange-50/50 border-b border-orange-100 flex justify-between items-center">
            <h2 className="text-xl font-black text-slate-800 tracking-tight">æœ€è¿‘å–äº†ä»€éº¼</h2>
            <span className="text-xs font-bold text-orange-400 uppercase tracking-wider">Recent Records</span>
          </div>
          <div className="overflow-x-auto">
            <table className="w-full text-left min-w-[600px]">
              <thead className="text-[11px] font-black text-slate-400 uppercase tracking-widest bg-slate-50">
                <tr>
                  <th className="px-6 py-4">æ—¥æœŸ</th>
                  <th className="px-6 py-4">åº—å®¶ / å“é …</th>
                  <th className="px-6 py-4">å®¢è£½åŒ–</th>
                  <th className="px-6 py-4">åƒ¹æ ¼</th>
                  <th className="px-6 py-4">å‚™è¨»</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-slate-100">
                {Object.keys(records).sort().reverse().map(d => (
                  <tr key={d} onClick={() => openModal(d)} className="hover:bg-orange-50 cursor-pointer transition-colors group">
                    <td className="px-6 py-4 font-bold text-slate-600">{d}</td>
                    <td className="px-6 py-4">
                      <div className="font-black text-slate-800">{records[d].shop}</div>
                      <div className="text-xs text-slate-500 font-bold">{records[d].item}</div>
                    </td>
                    <td className="px-6 py-4">
                      <div className="flex gap-1">
                        <span className="px-2 py-1 bg-cyan-100 text-cyan-700 rounded-md text-[10px] font-bold">{records[d].ice}</span>
                        <span className="px-2 py-1 bg-pink-100 text-pink-700 rounded-md text-[10px] font-bold">{records[d].sugar}</span>
                      </div>
                    </td>
                    <td className="px-6 py-4 font-black text-orange-500">${records[d].price}</td>
                    <td className="px-6 py-4 text-slate-400 text-xs max-w-[150px] truncate">{records[d].note || '-'}</td>
                  </tr>
                ))}
                {Object.keys(records).length === 0 && (
                  <tr>
                    <td colSpan="5" className="px-6 py-12 text-center text-slate-400 font-bold">ç›®å‰é‚„æ²’æœ‰ç´€éŒ„ï¼Œå¿«å»å–ä¸€æ¯å§ï¼</td>
                  </tr>
                )}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      {/* Edit Modal */}
      {modalOpen && (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm transition-all">
          <div className="bg-white w-full max-w-md rounded-[2.5rem] p-6 md:p-8 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div className="flex justify-between items-center mb-6">
              <h3 className="text-2xl font-black text-slate-800">{selectedDate}</h3>
              <button onClick={() => setModalOpen(false)} className="w-8 h-8 flex items-center justify-center bg-slate-100 rounded-full text-slate-400 hover:bg-slate-200">âœ•</button>
            </div>
            
            <div className="space-y-6">
              {/* åº—å®¶èˆ‡å“é … */}
              <div className="grid grid-cols-2 gap-4">
                <div className="col-span-1">
                  <label className="label-text">åº—å®¶åç¨±</label>
                  <input 
                    type="text" 
                    placeholder="ä¾‹å¦‚: 50åµ"
                    value={editData.shop}
                    onChange={(e) => setEditData({...editData, shop: e.target.value})}
                    className="input-field"
                    autoFocus
                  />
                </div>
                <div className="col-span-1">
                  <label className="label-text">åƒ¹æ ¼</label>
                  <input 
                    type="number" 
                    placeholder="$"
                    value={editData.price}
                    onChange={(e) => setEditData({...editData, price: e.target.value})}
                    className="input-field font-mono"
                  />
                </div>
              </div>
              
              <div>
                <label className="label-text">é£²æ–™å“é …</label>
                <input 
                  type="text" 
                  placeholder="ä¾‹å¦‚: å››å­£æ˜¥çæ³¢æ¤°"
                  value={editData.item}
                  onChange={(e) => setEditData({...editData, item: e.target.value})}
                  className="input-field"
                />
              </div>

              {/* å†°å¡Šé¸æ“‡ */}
              <div>
                <label className="label-text mb-2 block">å†°å¡Š</label>
                <div className="grid grid-cols-4 gap-2">
                  {iceOptions.map(opt => (
                    <button
                      key={opt}
                      onClick={() => setEditData({...editData, ice: opt})}
                      className={`py-2 rounded-xl text-xs font-bold transition-all border-2
                        ${editData.ice === opt 
                          ? 'bg-cyan-500 border-cyan-500 text-white shadow-md shadow-cyan-200' 
                          : 'border-slate-100 text-slate-400 hover:border-cyan-200 hover:text-cyan-400'}`}
                    >
                      {opt}
                    </button>
                  ))}
                </div>
              </div>

              {/* ç”œåº¦é¸æ“‡ */}
              <div>
                <label className="label-text mb-2 block">ç”œåº¦</label>
                <div className="grid grid-cols-4 gap-2">
                  {sugarOptions.map(opt => (
                    <button
                      key={opt}
                      onClick={() => setEditData({...editData, sugar: opt})}
                      className={`py-2 rounded-xl text-xs font-bold transition-all border-2
                        ${editData.sugar === opt 
                          ? 'bg-pink-500 border-pink-500 text-white shadow-md shadow-pink-200' 
                          : 'border-slate-100 text-slate-400 hover:border-pink-200 hover:text-pink-400'}`}
                    >
                      {opt}
                    </button>
                  ))}
                </div>
              </div>

              <div>
                <label className="label-text">å‚™è¨» / å¿ƒå¾—</label>
                <textarea 
                  value={editData.note}
                  onChange={(e) => setEditData({...editData, note: e.target.value})}
                  className="input-field h-20 resize-none"
                  placeholder="å¥½å–å—ï¼Ÿ"
                />
              </div>

              <div className="flex gap-3 pt-2">
                <button onClick={handleSave} className="flex-[2] bg-slate-900 text-white py-4 rounded-2xl font-black shadow-xl hover:bg-black transition-all active:scale-95">
                  å„²å­˜
                </button>
                {records[selectedDate] && (
                  <button onClick={handleDelete} className="flex-1 bg-rose-50 text-rose-500 py-4 rounded-2xl font-black hover:bg-rose-100 transition-all">
                    åˆªé™¤
                  </button>
                )}
              </div>
            </div>
          </div>
        </div>
      )}

      <style>{`
        .label-text {
          display: block;
          font-size: 0.75rem;
          font-weight: 900;
          color: #94a3b8;
          text-transform: uppercase;
          margin-bottom: 0.5rem;
        }
        .input-field {
          width: 100%;
          background-color: #f8fafc;
          border: 1px solid transparent;
          border-radius: 1rem;
          padding: 1rem;
          font-weight: 700;
          color: #334155;
          transition: all 0.2s;
        }
        .input-field:focus {
          outline: none;
          background-color: #fff;
          border-color: #fb923c;
          box-shadow: 0 0 0 4px rgba(251, 146, 60, 0.1);
        }
      `}</style>
    </div>
  );
}

function StatCard({ label, val, color, textColor = 'text-white' }) {
  return (
    <div className={`${color} min-w-[120px] flex-1 p-5 rounded-3xl shadow-lg flex flex-col justify-center items-start`}>
      <div className={`text-[10px] font-black uppercase opacity-60 mb-1 ${textColor}`}>{label}</div>
      <div className={`text-2xl font-black ${textColor}`}>{val}</div>
    </div>
  );
}