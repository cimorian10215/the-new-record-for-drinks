import React, { useState, useEffect, useMemo } from 'react';
import { 
  Calendar, ChevronLeft, ChevronRight, Plus, Trash2, 
  PieChart, DollarSign, Coffee, Loader2, Cloud
} from 'lucide-react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
import { 
  getFirestore, collection, doc, addDoc, deleteDoc, 
  onSnapshot, query, serverTimestamp 
} from 'firebase/firestore';

const app = initializeApp(firebaseConfig);

import { initializeApp } from "firebase/app";
import { getAnalytics } from "firebase/analytics";

const firebaseConfig = {
  apiKey: "AIzaSyAN6cKHHdtmSspoA9tOxH9VnWhczImhOlQ",
  authDomain: "the-new-record-for-drinks.firebaseapp.com",
  projectId: "the-new-record-for-drinks",
  storageBucket: "the-new-record-for-drinks.firebasestorage.app",
  messagingSenderId: "661434625679",
  appId: "1:661434625679:web:abe48c7a229e59a3334afa",
  measurementId: "G-T97XT0CMWQ"
};

// Initialize Firebase
const analytics = getAnalytics(app);

// 初始化 Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'drink-tracker-2026';

const App = () => {
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);
  const [currentDate, setCurrentDate] = useState(new Date(2026, 0, 1));
  const [drinks, setDrinks] = useState({});
  const [selectedDate, setSelectedDate] = useState(null);
  const [isModalOpen, setIsModalOpen] = useState(false);

  // 表單狀態
  const [formData, setFormData] = useState({
    shop: '',
    item: '',
    ice: '微冰',
    sugar: '微糖',
    price: '',
    note: ''
  });

  const iceOptions = ['正常', '少冰', '微冰', '去冰', '常溫', '溫'];
  const sugarOptions = ['全糖', '少糖', '半糖', '微糖', '一分糖', '無糖'];

  // 1. 處理身份驗證 (使用匿名登入以實現雲端同步)
  useEffect(() => {
    const initAuth = async () => {
      try {
        // 如果環境有提供 token 則使用，否則匿名登入
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          // signInWithCustomToken 需要從 firebase/auth 導入，這裡簡化處理
        } else {
          await signInAnonymously(auth);
        }
      } catch (error) {
        console.error("Firebase 認證失敗:", error);
      }
    };

    initAuth();
    const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
      setUser(currentUser);
      if (!currentUser) setLoading(false);
    });
    return () => unsubscribe();
  }, []);

  // 2. 實時從 Firestore 同步資料
  useEffect(() => {
    if (!user) return;

    // 依照規定路徑存取資料: /artifacts/{appId}/users/{userId}/drinks
    const drinksCollection = collection(db, 'artifacts', appId, 'users', user.uid, 'drinks');
    
    const unsubscribe = onSnapshot(drinksCollection, (snapshot) => {
      const data = {};
      snapshot.forEach((doc) => {
        const drink = { ...doc.data(), id: doc.id };
        const dateKey = drink.dateKey;
        if (!data[dateKey]) data[dateKey] = [];
        data[dateKey].push(drink);
      });
      setDrinks(data);
      setLoading(false);
    }, (error) => {
      console.error("Firestore 同步錯誤:", error);
      setLoading(false);
    });

    return () => unsubscribe();
  }, [user]);

  // 日曆計算邏輯
  const calendarDays = useMemo(() => {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    const firstDayOfMonth = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const days = [];
    for (let i = 0; i < firstDayOfMonth; i++) days.push(null);
    for (let i = 1; i <= daysInMonth; i++) days.push(new Date(year, month, i));
    return days;
  }, [currentDate]);

  // 統計邏輯
  const stats = useMemo(() => {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    const monthKeyPrefix = `${year}-${String(month + 1).padStart(2, '0')}`;
    let totalSpent = 0;
    let totalDrinks = 0;
    Object.keys(drinks).forEach(dateKey => {
      if (dateKey.startsWith(monthKeyPrefix)) {
        drinks[dateKey].forEach(drink => {
          totalSpent += Number(drink.price) || 0;
          totalDrinks += 1;
        });
      }
    });
    return { totalSpent, totalDrinks };
  }, [drinks, currentDate]);

  const formatDateKey = (date) => {
    if (!date) return '';
    return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
  };

  const openAddModal = (date) => {
    setSelectedDate(formatDateKey(date));
    setFormData({ shop: '', item: '', ice: '微冰', sugar: '微糖', price: '', note: '' });
    setIsModalOpen(true);
  };

  const saveDrink = async () => {
    if (!user) return;
    if (!formData.shop || !formData.item) {
      alert('請填寫店名與品項！');
      return;
    }

    try {
      const drinksCollection = collection(db, 'artifacts', appId, 'users', user.uid, 'drinks');
      await addDoc(drinksCollection, {
        ...formData,
        dateKey: selectedDate,
        createdAt: serverTimestamp()
      });
      setIsModalOpen(false);
    } catch (error) {
      console.error("儲存失敗:", error);
      alert("同步至雲端失敗，請檢查網路連接。");
    }
  };

  const deleteDrink = async (drinkId) => {
    if (!user) return;
    try {
      const drinkDoc = doc(db, 'artifacts', appId, 'users', user.uid, 'drinks', drinkId);
      await deleteDoc(drinkDoc);
    } catch (error) {
      console.error("刪除失敗:", error);
    }
  };

  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-orange-50">
        <div className="text-center">
          <Loader2 className="w-10 h-10 text-orange-500 animate-spin mx-auto mb-4" />
          <p className="text-orange-600 font-bold animate-pulse">雲端資料同步中...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-orange-50 p-4 md:p-8 font-sans text-slate-800">
      <div className="max-w-5xl mx-auto">
        {/* Header */}
        <header className="flex flex-col md:flex-row md:items-center justify-between mb-8 bg-white p-6 rounded-3xl shadow-sm border border-orange-100">
          <div className="flex items-center gap-4">
            <div className="p-3 bg-orange-500 rounded-2xl text-white shadow-lg shadow-orange-200">
              <Coffee className="w-8 h-8" />
            </div>
            <div>
              <h1 className="text-3xl font-black text-slate-800">手搖統計</h1>
              <div className="flex items-center gap-2 mt-1">
                <Cloud className="w-3 h-3 text-green-500" />
                <p className="text-[10px] text-slate-400 font-bold uppercase tracking-widest">已連接雲端同步</p>
              </div>
            </div>
          </div>
          
          <div className="flex gap-4 mt-6 md:mt-0">
            <div className="bg-orange-100 px-5 py-3 rounded-2xl flex items-center gap-3">
              <div className="p-2 bg-white rounded-xl text-orange-600 shadow-sm"><DollarSign className="w-5 h-5" /></div>
              <div>
                <p className="text-[10px] text-orange-700 font-bold uppercase opacity-60">本月花費</p>
                <p className="text-2xl font-black text-orange-600">${stats.totalSpent}</p>
              </div>
            </div>
            <div className="bg-blue-100 px-5 py-3 rounded-2xl flex items-center gap-3">
              <div className="p-2 bg-white rounded-xl text-blue-600 shadow-sm"><PieChart className="w-5 h-5" /></div>
              <div>
                <p className="text-[10px] text-blue-700 font-bold uppercase opacity-60">飲用杯數</p>
                <p className="text-2xl font-black text-blue-600">{stats.totalDrinks}</p>
              </div>
            </div>
          </div>
        </header>

        {/* Calendar Controls */}
        <div className="flex items-center justify-between mb-6 px-2">
          <h2 className="text-2xl font-black text-slate-700 flex items-center gap-2">
            {currentDate.getFullYear()} 年 {currentDate.getMonth() + 1} 月
          </h2>
          <div className="flex gap-2 bg-white p-1 rounded-2xl border border-slate-100 shadow-sm">
            <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1))} className="p-2 hover:bg-orange-50 rounded-xl transition-colors">
              <ChevronLeft className="w-6 h-6 text-slate-400" />
            </button>
            <button onClick={() => setCurrentDate(new Date(2026, currentDate.getMonth(), 1))} className="px-3 text-xs font-bold text-slate-400 hover:text-orange-500">2026</button>
            <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1))} className="p-2 hover:bg-orange-50 rounded-xl transition-colors">
              <ChevronRight className="w-6 h-6 text-slate-400" />
            </button>
          </div>
        </div>

        {/* Calendar Grid */}
        <div className="grid grid-cols-7 gap-2 md:gap-3">
          {['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'].map(day => (
            <div key={day} className="text-center text-[10px] font-black text-slate-300 py-2 uppercase tracking-widest">{day}</div>
          ))}
          {calendarDays.map((date, index) => {
            const dateKey = formatDateKey(date);
            const dayDrinks = drinks[dateKey] || [];
            const isToday = date && new Date().toDateString() === date.toDateString();
            
            return (
              <div 
                key={index} 
                className={`min-h-[100px] md:min-h-[150px] bg-white rounded-3xl p-3 border border-slate-100 shadow-sm flex flex-col transition-all group ${!date ? 'bg-slate-50 opacity-20' : 'cursor-pointer hover:border-orange-200 hover:shadow-orange-100 hover:shadow-lg'}`}
                onClick={() => date && openAddModal(date)}
              >
                {date && (
                  <>
                    <div className="flex justify-between items-start mb-2">
                      <span className={`text-sm font-black ${isToday ? 'bg-orange-500 text-white w-6 h-6 flex items-center justify-center rounded-full' : (date.getDay() === 0 || date.getDay() === 6 ? 'text-red-400' : 'text-slate-400')}`}>
                        {date.getDate()}
                      </span>
                      {dayDrinks.length > 0 && <div className="w-2 h-2 bg-orange-400 rounded-full animate-pulse" />}
                    </div>
                    <div className="flex-1 overflow-hidden space-y-1">
                      {dayDrinks.slice(0, 3).map(drink => (
                        <div key={drink.id} className="text-[10px] bg-orange-50 text-orange-700 px-2 py-1 rounded-lg border border-orange-100 truncate font-medium">
                          {drink.shop}
                        </div>
                      ))}
                      {dayDrinks.length > 3 && <div className="text-[9px] text-center text-slate-300 font-bold">+{dayDrinks.length - 3} 更多</div>}
                    </div>
                    <div className="mt-2 opacity-0 group-hover:opacity-100 transition-opacity">
                      <div className="w-full py-1 bg-slate-50 rounded-xl flex justify-center"><Plus className="w-4 h-4 text-slate-300" /></div>
                    </div>
                  </>
                )}
              </div>
            );
          })}
        </div>
      </div>

      {/* Modal (表單部分保持不變) */}
      {isModalOpen && (
        <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-md flex items-center justify-center p-4 z-50">
          <div className="bg-white w-full max-w-lg rounded-[2.5rem] shadow-2xl overflow-hidden max-h-[90vh] flex flex-col animate-in fade-in zoom-in duration-200">
            <div className="bg-gradient-to-r from-orange-500 to-orange-600 p-8 text-white flex justify-between items-center">
              <div>
                <h3 className="text-2xl font-black">飲品記錄</h3>
                <p className="text-orange-100 text-sm font-bold opacity-80 mt-1">{selectedDate}</p>
              </div>
              <button onClick={() => setIsModalOpen(false)} className="bg-white/20 hover:bg-white/40 w-10 h-10 rounded-full flex items-center justify-center transition-colors">✕</button>
            </div>

            <div className="p-8 overflow-y-auto space-y-8">
              {drinks[selectedDate] && (
                <div className="space-y-3">
                  <h4 className="text-xs font-black text-slate-400 uppercase tracking-widest">今日清單</h4>
                  {drinks[selectedDate].map(drink => (
                    <div key={drink.id} className="flex items-center justify-between bg-slate-50 p-4 rounded-2xl border border-slate-100 group">
                      <div>
                        <p className="font-black text-slate-700">{drink.shop} <span className="text-orange-500 mx-1">/</span> {drink.item}</p>
                        <p className="text-[10px] text-slate-400 font-bold uppercase mt-1">{drink.ice} · {drink.sugar} · ${drink.price}</p>
                      </div>
                      <button onClick={(e) => { e.stopPropagation(); deleteDrink(drink.id); }} className="text-slate-300 hover:text-red-500 p-2 transition-colors">
                        <Trash2 className="w-5 h-5" />
                      </button>
                    </div>
                  ))}
                </div>
              )}

              <div className="space-y-6 pt-4 border-t border-slate-100">
                <div className="grid grid-cols-2 gap-4">
                  <div className="space-y-2">
                    <label className="text-xs font-black text-slate-400 uppercase tracking-widest ml-1">店名</label>
                    <input className="w-full bg-slate-50 border-2 border-transparent focus:border-orange-500 focus:bg-white rounded-2xl px-5 py-3 outline-none transition-all font-bold" placeholder="例如：得正" value={formData.shop} onChange={e => setFormData({...formData, shop: e.target.value})} />
                  </div>
                  <div className="space-y-2">
                    <label className="text-xs font-black text-slate-400 uppercase tracking-widest ml-1">品項</label>
                    <input className="w-full bg-slate-50 border-2 border-transparent focus:border-orange-500 focus:bg-white rounded-2xl px-5 py-3 outline-none transition-all font-bold" placeholder="檸檬春烏龍" value={formData.item} onChange={e => setFormData({...formData, item: e.target.value})} />
                  </div>
                </div>

                <div className="space-y-3">
                  <label className="text-xs font-black text-slate-400 uppercase tracking-widest ml-1">冰塊</label>
                  <div className="grid grid-cols-3 md:grid-cols-6 gap-2">
                    {iceOptions.map(opt => (
                      <button key={opt} onClick={() => setFormData({...formData, ice: opt})} className={`py-3 text-xs font-bold rounded-xl border-2 transition-all ${formData.ice === opt ? 'bg-orange-500 border-orange-500 text-white shadow-lg shadow-orange-100' : 'bg-white border-slate-100 text-slate-400 hover:border-orange-200 hover:text-orange-500'}`}>{opt}</button>
                    ))}
                  </div>
                </div>

                <div className="space-y-3">
                  <label className="text-xs font-black text-slate-400 uppercase tracking-widest ml-1">甜度</label>
                  <div className="grid grid-cols-3 md:grid-cols-6 gap-2">
                    {sugarOptions.map(opt => (
                      <button key={opt} onClick={() => setFormData({...formData, sugar: opt})} className={`py-3 text-xs font-bold rounded-xl border-2 transition-all ${formData.sugar === opt ? 'bg-orange-500 border-orange-500 text-white shadow-lg shadow-orange-100' : 'bg-white border-slate-100 text-slate-400 hover:border-orange-200 hover:text-orange-500'}`}>{opt}</button>
                    ))}
                  </div>
                </div>

                <div className="grid grid-cols-3 gap-4">
                  <div className="space-y-2">
                    <label className="text-xs font-black text-slate-400 uppercase tracking-widest ml-1">價格</label>
                    <input type="number" className="w-full bg-slate-50 border-2 border-transparent focus:border-orange-500 focus:bg-white rounded-2xl px-5 py-3 outline-none transition-all font-bold" placeholder="$" value={formData.price} onChange={e => setFormData({...formData, price: e.target.value})} />
                  </div>
                  <div className="col-span-2 space-y-2">
                    <label className="text-xs font-black text-slate-400 uppercase tracking-widest ml-1">備註</label>
                    <input className="w-full bg-slate-50 border-2 border-transparent focus:border-orange-500 focus:bg-white rounded-2xl px-5 py-3 outline-none transition-all font-bold" placeholder="加波霸、不要袋子..." value={formData.note} onChange={e => setFormData({...formData, note: e.target.value})} />
                  </div>
                </div>
              </div>
            </div>

            <div className="p-8 bg-slate-50 border-t border-slate-100 flex gap-4">
              <button onClick={() => setIsModalOpen(false)} className="flex-1 py-4 rounded-2xl bg-white border-2 border-slate-200 font-black text-slate-400 hover:bg-slate-100 hover:text-slate-600 transition-all">取消</button>
              <button onClick={saveDrink} className="flex-[2] py-4 rounded-2xl bg-orange-600 font-black text-white shadow-xl shadow-orange-200 hover:bg-orange-700 hover:-translate-y-1 active:translate-y-0 transition-all">儲存這份快樂 ✨</button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default App;