<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰‹æ–çµ±è¨ˆ 2026 è·¨è£ç½®ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-orange-50 min-h-screen">
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- è«‹å¡«å…¥æ‚¨è‡ªå·±çš„ Firebase é…ç½® ---
        const firebaseConfig = {
            apiKey: "AIzaSyAN6cKHHdtmSspoA9tOxH9VnWhczImhOlQ",
            authDomain: "the-new-record-for-drinks.firebaseapp.com",
            projectId: "the-new-record-for-drinks",
            storageBucket: "the-new-record-for-drinks.firebasestorage.app",
            messagingSenderId: "661434625679",
            appId: "1:661434625679:web:abe48c7a229e59a3334af"
        };

        const app = initializeApp(firebaseConfig);
        window.fbDb = getFirestore(app);
        window.fbMethods = { doc, setDoc, onSnapshot, getDoc };
    </script>

    <script type="text/babel">
        const { useState, useEffect } = React;

        function App() {
            const [syncKey, setSyncKey] = useState(localStorage.getItem('drink_sync_key') || '');
            const [records, setRecords] = useState({});
            const [loading, setLoading] = useState(false);
            const [modalOpen, setModalOpen] = useState(false);
            const [selectedDate, setSelectedDate] = useState('');
            const [statusMsg, setStatusMsg] = useState('');
            
            // ç·¨è¼¯ä¸­çš„å¤šæ¯åˆ—è¡¨
            const [editingDrinks, setEditingDrinks] = useState([]);

            const iceOptions = ['æ­£å¸¸', 'å°‘å†°', 'å¾®å†°', 'å»å†°', 'å¸¸æº«', 'æº«', 'å›ºå®š'];
            const sugarOptions = ['å…¨ç³–', 'å°‘ç³–', 'åŠç³–', 'å¾®ç³–', 'ä¸€åˆ†', 'ç„¡ç³–', 'å›ºå®š'];

            // éš¨æ©Ÿç”¢ç”Ÿé‡‘é‘°
            const generateKey = () => {
                const key = Math.random().toString(36).substring(2, 10).toUpperCase();
                setSyncKey(key);
                localStorage.setItem('drink_sync_key', key);
            };

            // ç›£è½é›²ç«¯è³‡æ–™
            useEffect(() => {
                if (!syncKey || !window.fbDb) return;
                setLoading(true);
                const { doc, onSnapshot } = window.fbMethods;
                const docRef = doc(window.fbDb, 'drink_v2', syncKey);
                
                const unsubscribe = onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        setRecords(docSnap.data().records || {});
                    } else {
                        setRecords({});
                    }
                    setLoading(false);
                }, (err) => {
                    console.error(err);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, [syncKey]);

            const saveToCloud = async (newRecords) => {
                if (!syncKey) return;
                const { doc, setDoc } = window.fbMethods;
                try {
                    const docRef = doc(window.fbDb, 'drink_v2', syncKey);
                    await setDoc(docRef, { records: newRecords });
                    setStatusMsg('âœ… é›²ç«¯åŒæ­¥ä¸­');
                    setTimeout(() => setStatusMsg(''), 2000);
                } catch (err) {
                    alert('åŒæ­¥å¤±æ•—: ' + err.message);
                }
            };

            const openModal = (date) => {
                setSelectedDate(date);
                // å¦‚æœè©²æ—¥æœŸå·²æœ‰è³‡æ–™ï¼Œè®€å–é™£åˆ—ï¼›è‹¥ç„¡ï¼Œé è¨­ä¸€æ¯ç©ºè³‡æ–™
                const existing = records[date] || [{ shop: '', item: '', price: '', ice: 'å°‘å†°', sugar: 'å¾®ç³–', id: Date.now() }];
                setEditingDrinks(JSON.parse(JSON.stringify(existing)));
                setModalOpen(true);
            };

            const addDrinkField = () => {
                setEditingDrinks([...editingDrinks, { shop: '', item: '', price: '', ice: 'å°‘å†°', sugar: 'å¾®ç³–', id: Date.now() }]);
            };

            const removeDrinkField = (index) => {
                const updated = editingDrinks.filter((_, i) => i !== index);
                setEditingDrinks(updated);
            };

            const handleUpdateDrink = (index, field, value) => {
                const updated = [...editingDrinks];
                updated[index][field] = value;
                setEditingDrinks(updated);
            };

            const handleSave = () => {
                // éæ¿¾æ‰å®Œå…¨æ²’å¡«å¯«åº—åçš„ç©ºç™½åˆ—
                const validDrinks = editingDrinks.filter(d => d.shop.trim() !== '');
                const newRecords = { ...records };
                if (validDrinks.length > 0) {
                    newRecords[selectedDate] = validDrinks;
                } else {
                    delete newRecords[selectedDate];
                }
                setRecords(newRecords);
                saveToCloud(newRecords);
                setModalOpen(false);
            };

            // çµ±è¨ˆ
            const stats = Object.values(records).flat().reduce((acc, r) => {
                acc.totalSpent += (parseInt(r.price) || 0);
                acc.totalCups += 1;
                return acc;
            }, { totalSpent: 0, totalCups: 0 });

            if (!syncKey) {
                return (
                    <div className="flex h-screen items-center justify-center p-6 text-center">
                        <div className="bg-white p-8 rounded-[2.5rem] shadow-2xl max-w-sm border border-orange-100">
                            <div className="text-6xl mb-4">ğŸ§‹</div>
                            <h2 className="text-2xl font-black text-slate-800 mb-2">å•Ÿå‹•åŒæ­¥åŠŸèƒ½</h2>
                            <p className="text-slate-500 text-sm mb-6 font-medium">è«‹è¼¸å…¥æ‚¨çš„å€‹äººå¯†é‘°ï¼Œæˆ–ç”¢ç”Ÿä¸€å€‹æ–°å¯†é‘°ä»¥é–‹å§‹è·¨è£ç½®åŒæ­¥ã€‚</p>
                            <input 
                                type="text" 
                                placeholder="è¼¸å…¥ 8 ä½å¯†é‘°" 
                                className="w-full p-4 bg-slate-50 rounded-2xl mb-4 text-center font-mono font-bold uppercase"
                                id="keyInput"
                            />
                            <button 
                                onClick={() => {
                                    const val = document.getElementById('keyInput').value.toUpperCase().trim();
                                    if(val) { setSyncKey(val); localStorage.setItem('drink_sync_key', val); }
                                }}
                                className="w-full bg-slate-900 text-white py-4 rounded-2xl font-black mb-2 shadow-lg"
                            >
                                é€²å…¥æˆ‘çš„ç´€éŒ„
                            </button>
                            <button 
                                onClick={generateKey}
                                className="w-full bg-orange-100 text-orange-600 py-4 rounded-2xl font-black"
                            >
                                ç”¢ç”Ÿæ–°å¯†é‘°
                            </button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="p-4 md:p-8 max-w-6xl mx-auto pb-20">
                    {statusMsg && (
                        <div className="fixed top-4 right-4 bg-emerald-500 text-white px-6 py-3 rounded-2xl shadow-lg z-50 font-bold animate-bounce text-sm">
                            {statusMsg}
                        </div>
                    )}
                    
                    <header className="bg-white p-6 rounded-[2rem] shadow-xl mb-8 flex flex-col md:flex-row justify-between items-center gap-6 border border-orange-100">
                        <div className="text-center md:text-left">
                            <h1 className="text-3xl font-black text-slate-800 flex items-center gap-2 justify-center md:justify-start">ğŸ§‹ æ‰‹æ–çµ±è¨ˆ 2026</h1>
                            <div className="mt-2 flex items-center gap-2 text-[10px] font-bold text-slate-400 bg-slate-50 px-3 py-1 rounded-full border">
                                ğŸ”‘ åŒæ­¥å¯†é‘°ï¼š<span className="text-orange-500 font-mono select-all">{syncKey}</span>
                            </div>
                        </div>
                        <div className="flex gap-4 w-full md:w-auto">
                            <div className="flex-1 bg-slate-900 text-white p-4 rounded-2xl text-center min-w-[120px] shadow-lg">
                                <div className="text-[10px] font-black opacity-50 uppercase tracking-tighter">å¹´åº¦ç¸½æ”¯å‡º</div>
                                <div className="text-2xl font-black">${stats.totalSpent}</div>
                            </div>
                            <div className="flex-1 bg-orange-500 text-white p-4 rounded-2xl text-center min-w-[120px] shadow-lg">
                                <div className="text-[10px] font-black opacity-50 uppercase tracking-tighter">ç´¯ç©æ¯æ•¸</div>
                                <div className="text-2xl font-black">{stats.totalCups}</div>
                            </div>
                        </div>
                    </header>

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                        {[...Array(12).keys()].map(m => {
                            const days = [];
                            const firstDay = new Date(2026, m, 1).getDay();
                            const totalDays = new Date(2026, m+1, 0).getDate();
                            for(let i=0; i<firstDay; i++) days.push(null);
                            for(let i=1; i<=totalDays; i++) days.push(i);

                            return (
                                <div key={m} className="bg-white p-5 rounded-3xl shadow-sm border border-orange-50">
                                    <h3 className="font-black text-orange-800 mb-3 text-lg">2026 / {m+1}æœˆ</h3>
                                    <div className="grid grid-cols-7 gap-1 text-[10px] font-black text-center text-slate-300 mb-2">
                                        {['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].map(w => <div key={w}>{w}</div>)}
                                    </div>
                                    <div className="grid grid-cols-7 gap-1.5">
                                        {days.map((d, idx) => {
                                            if(!d) return <div key={idx}/>;
                                            const dStr = `2026-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                                            const dayDrinks = records[dStr] || [];
                                            const dayTotal = dayDrinks.reduce((sum, item) => sum + (parseInt(item.price) || 0), 0);
                                            
                                            return (
                                                <div 
                                                    key={dStr} 
                                                    onClick={() => openModal(dStr)} 
                                                    className={`aspect-square flex flex-col items-center justify-center rounded-xl cursor-pointer transition-all hover:scale-110 active:scale-95 border relative
                                                    ${dayDrinks.length > 0 ? 'bg-orange-500 border-orange-600 text-white shadow-md shadow-orange-100' : 'border-transparent text-slate-400 hover:bg-orange-50'}`}
                                                >
                                                    <span className="text-xs font-bold">{d}</span>
                                                    {dayDrinks.length > 0 && (
                                                        <span className="text-[7px] font-black absolute bottom-1 truncate px-0.5 w-full text-center">
                                                            {dayDrinks.length > 1 ? `x${dayDrinks.length}` : `$${dayTotal}`}
                                                        </span>
                                                    )}
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            );
                        })}
                    </div>

                    {modalOpen && (
                        <div className="fixed inset-0 bg-slate-900/70 backdrop-blur-md flex items-center justify-center p-4 z-50 overflow-y-auto">
                            <div className="bg-white p-6 md:p-8 rounded-[2.5rem] w-full max-w-md shadow-2xl my-auto animate-in fade-in zoom-in duration-200">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-2xl font-black text-slate-800">{selectedDate}</h2>
                                    <button onClick={()=>setModalOpen(false)} className="text-slate-300 hover:text-slate-500 text-2xl px-2">âœ•</button>
                                </div>
                                
                                <div className="space-y-8 max-h-[60vh] overflow-y-auto pr-2 custom-scroll">
                                    {editingDrinks.map((drink, index) => (
                                        <div key={drink.id} className="p-5 bg-slate-50 rounded-[2rem] space-y-4 relative border border-slate-100 shadow-inner">
                                            {editingDrinks.length > 1 && (
                                                <button 
                                                    onClick={() => removeDrinkField(index)}
                                                    className="absolute -top-2 -right-2 bg-rose-500 text-white w-7 h-7 rounded-full text-xs font-bold shadow-lg"
                                                >
                                                    âœ•
                                                </button>
                                            )}
                                            <div className="grid grid-cols-2 gap-3">
                                                <input type="text" placeholder="åº—å®¶" className="col-span-1 p-3 bg-white rounded-xl font-bold text-sm shadow-sm" value={drink.shop} onChange={e=>handleUpdateDrink(index, 'shop', e.target.value)}/>
                                                <input type="number" placeholder="åƒ¹æ ¼" className="col-span-1 p-3 bg-white rounded-xl font-bold text-sm shadow-sm" value={drink.price} onChange={e=>handleUpdateDrink(index, 'price', e.target.value)}/>
                                                <input type="text" placeholder="å“é …åç¨±" className="col-span-2 p-3 bg-white rounded-xl font-bold text-sm shadow-sm" value={drink.item} onChange={e=>handleUpdateDrink(index, 'item', e.target.value)}/>
                                            </div>

                                            <div className="space-y-1">
                                                <div className="text-[9px] font-black text-slate-400 uppercase tracking-widest ml-1">å†°å¡Š</div>
                                                <div className="flex flex-wrap gap-1">
                                                    {iceOptions.map(o => (
                                                        <button key={o} onClick={()=>handleUpdateDrink(index, 'ice', o)} className={`px-2 py-1.5 rounded-lg text-[10px] font-bold border-2 transition-all ${drink.ice===o ? 'bg-cyan-500 border-cyan-500 text-white shadow-md' : 'border-white bg-white text-slate-400 hover:border-cyan-100'}`}>{o}</button>
                                                    ))}
                                                </div>
                                            </div>

                                            <div className="space-y-1">
                                                <div className="text-[9px] font-black text-slate-400 uppercase tracking-widest ml-1">ç”œåº¦</div>
                                                <div className="flex flex-wrap gap-1">
                                                    {sugarOptions.map(o => (
                                                        <button key={o} onClick={()=>handleUpdateDrink(index, 'sugar', o)} className={`px-2 py-1.5 rounded-lg text-[10px] font-bold border-2 transition-all ${drink.sugar===o ? 'bg-pink-500 border-pink-500 text-white shadow-md' : 'border-white bg-white text-slate-400 hover:border-pink-100'}`}>{o}</button>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>

                                <button 
                                    onClick={addDrinkField}
                                    className="w-full mt-4 border-2 border-dashed border-slate-200 text-slate-400 py-3 rounded-2xl font-black text-sm hover:bg-slate-50 hover:border-orange-200 hover:text-orange-400 transition-all"
                                >
                                    + æ–°å¢ä¸€æ¯é£²å“
                                </button>

                                <div className="flex gap-3 pt-6">
                                    <button onClick={handleSave} className="flex-[2] bg-slate-900 text-white py-4 rounded-2xl font-black shadow-xl hover:bg-black active:scale-95 transition-all">ç¢ºèªå„²å­˜</button>
                                    <button onClick={()=>setModalOpen(false)} className="flex-1 bg-slate-100 text-slate-500 py-4 rounded-2xl font-bold hover:bg-slate-200">å–æ¶ˆ</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
    <style>
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
    </style>
</body>
</html>